<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Zen Canvas Editor</title>
	<link rel="stylesheet" href="node_modules/codemirror/lib/codemirror.css">
	<link rel="stylesheet" href="node_modules/codemirror/theme/monokai.css">
	<script src="node_modules/codemirror/lib/codemirror.js"></script>
	<script src="node_modules/codemirror/mode/javascript/javascript.js"></script>
	<script src="node_modules/codemirror/addon/edit/closebrackets.js"></script>
	<script src="node_modules/codemirror/addon/edit/matchbrackets.js"></script>
	<link rel="stylesheet" href="app.css">
</head>
<body>
	<iframe id="preview" src="preview.html" sandbox="allow-same-origin allow-scripts"></iframe>
	<div id="editor"></div>

	<script>
		var editorEl = document.querySelector('#editor');
		var dockSide = 'center';
		var previewFrame = document.querySelector('#preview');
		var previewWindow = previewFrame.contentWindow;
		var previewTimeout;

		var editor = CodeMirror(function(el) {
			document.querySelector('#editor').appendChild(el);
		}, {
			theme: 'monokai',
			lineNumbers: true,
			lineWrapping: true,
			tabSize: 2,
			indentWithTabs: true,
			autoCloseBrackets: true,
			matchBrackets: true,
			value: localStorage.getItem('autosave') || '',
			extraKeys: {
				'Ctrl-Alt-Left': dock('left', 'right'),
				'Ctrl-Alt-Right': dock('right', 'left')
				// 'Ctrl-Alt-Up': dock('top', 'bottom'),
				// 'Ctrl-Alt-Down': dock('bottom', 'top'),
			}
		});

		editor.on('change', function() {
			clearTimeout(previewTimeout);
			previewTimeout = setTimeout(preview, 300);
		});

		function preview() {
			var code = editor.getValue();

			previewWindow.postMessage({
				type: 'code',
				data: code
			}, '*');

			localStorage.setItem('autosave', code);
		}

		previewWindow.addEventListener('load', preview);

		function dock(side, opSide) {
			return function(cm) {
				document.body.classList.remove('dock-' + dockSide);
				if (opSide == dockSide)
					document.body.classList.remove('dock');
				else
					document.body.classList.add('dock', 'dock-' + side);
				cm.refresh();
				dockSide = side;
				localStorage.setItem('dock_side', dockSide);
			};
		}

		function notifError() {
			editorEl.classList.add('has-error');
		}

		function notifAlright() {
			editorEl.classList.remove('has-error');
		}

		window.addEventListener('message', function(e) {
			var message = e.data;

			switch (message.type) {
				case 'error':
					notifError();
					break;

				case 'success':
					notifAlright();
					break;
			}
		});

		var storedDockSide = localStorage.getItem('dock_side');
		if ('left' == storedDockSide)
			dock('left', 'right')(editor);
		else if ('right' == storedDockSide)
			dock('right', 'left')(editor);
	</script>
</body>
</html>
